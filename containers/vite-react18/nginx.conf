events {
    worker_connections 1024; # Adjust as needed
}

http {
    # Include MIME types
    include       mime.types;
    default_type  application/octet-stream;

    # Disable caching (useful for dev environments)
    sendfile        on;
    keepalive_timeout  65;

    # Server block for dynamic workspace routing
    server {
        listen 80;
        server_name ~^(?<workspace_id>[a-zA-Z0-9\-]+)-workspace\.bones\.test$;

        # Logs for debugging (optional)
        access_log  /var/log/nginx/workspace_access.log;
        error_log   /var/log/nginx/workspace_error.log;

        # Route requests to the workspace service
        location / {
            # Pass requests to the Kubernetes service using dynamic subdomains
            proxy_pass http://workspace-service-${workspace_id}:80;

            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Preserve client information
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Disable caching
            add_header Last-Modified $date_gmt;
            add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
            if_modified_since off;
            expires off;
            etag off;
            proxy_no_cache 1;
            proxy_cache_bypass 1;
        }

        # Bridge service routing
        location /_bridge {
            # Strip the /_bridge prefix and pass the request to the Bridge service
            rewrite ^/_bridge(.*)$ $1 break;

            # Replace localhost with the bridge service's actual host if different
            proxy_pass http://localhost:4000; 
            proxy_http_version 1.1;

            # WebSocket support
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Preserve client information
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
